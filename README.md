# BotBuilder



## Introï¼š

BotBuilder ç”±ä¸‰å€‹å°ˆæ¡ˆçµ„æˆ

[BotBuilder](https://github.com/den19980107/BotBuilder): botbuilder çš„å¾Œç«¯ï¼Œç”± node.js express.js mongodb çµ„æˆ

[botbuilder-ui](https://github.com/den19980107/botbuilder-ui): botbuilder çš„å‰ç«¯ï¼Œç”± react çµ„æˆ

[Botbuilder.Share](https://github.com/den19980107/Botbuilder.Share): ç”¨ä¾†å…±äº«å‰å¾Œç«¯çš„ typing



## ä»‹ç´¹ï¼š

æ­¤å°ˆæ¡ˆæ˜¯ä¸€å€‹æµç¨‹è¨­è¨ˆè»Ÿé«”ï¼Œç›®çš„æ˜¯è®“ä½¿ç”¨è€…å¯ä»¥åœ¨ä¸éœ€è¦æœƒå¯«ç¨‹å¼çš„æƒ…æ³ä¸‹ï¼Œé€éæ‹–æ‹‰ç¯€é»çš„æ–¹å¼å°‡æ‰€éœ€è¦çš„åŠŸèƒ½ä»¥æµç¨‹åœ–çš„æ–¹å¼çµ„åˆå‡ºä¾†ã€‚

## ç¯€é»é¡åˆ¥ï¼š

* eventï¼šäº‹ä»¶é¡å‹ç¯€é»ï¼Œç‚ºä¸€å€‹æµç¨‹ä¸­çš„ç¬¬ä¸€å€‹ç¯€é»ï¼Œå¦‚ `æ’ç¨‹`ã€`å»ºç«‹ API`ç­‰ç¯€é»éƒ½æ˜¯äº‹ä»¶ç¯€é»
* processï¼šè™•ç†é¡å‹ç¯€é»ï¼Œè² è²¬å„ç¨®è¨ˆç®—ã€è³‡æ–™è™•ç†ã€å‘¼å« API ç­‰éƒ½æ˜¯è™•ç†ç¯€é»
* conditionï¼šæ¢ä»¶åˆ¤æ–·ç¯€é»ï¼Œè² è²¬è™•ç†æµç¨‹çš„æ¢ä»¶åˆ¤æ–·
* resultï¼šçµæŸç¯€é»ï¼Œç‚ºä¸€å€‹æµç¨‹çš„çµæŸï¼Œå¦‚ `http response` ç¯€é»

## ç¯€é»ï¼ˆnodeï¼‰ï¼š

> ### å±¬æ€§ï¼š
>
> æ¯ä¸€å€‹ç¯€é»éƒ½æœƒåŒ…å«ä»¥ä¸‹åŸºæœ¬çš„å¹¾å€‹å±¬æ€§
>
> * idï¼šç¯€é»çš„ id
> * nameï¼šç¯€é»çš„åç¨±
> * payloadï¼šç¯€é»å…§çš„è³‡æ–™ï¼Œä¾‹å¦‚æ’ç¨‹ç¯€é»æœƒæœ‰ `é–‹å§‹æ—¥æœŸ`ã€`çµæŸæ—¥æœŸ`ã€`æ™‚é–“` ... ç­‰ç­‰ï¼Œæ ¹æ“šä¸åŒç¯€é»éœ€è¦çš„è³‡æ–™ä¸åŒï¼Œpayload å…§çš„è³‡æ–™ä¹Ÿæœƒä¸åŒ
> * typeï¼šç¯€é»çš„é¡åˆ¥ï¼Œå¦‚ä¸Šé¢ç¯€é»é¡åˆ¥ä»‹ç´¹çš„
> * next_node_idï¼šæ¥è‘—æ­¤ç¯€é»å¾ŒåŸ·è¡Œçš„ç¯€é» id

>### ç”Ÿå‘½é€±æœŸæ–¹æ³•ï¼š
>
>ä¸€å€‹ç¯€é»ç›®å‰åªæœƒæœ‰ä¸‰å€‹ç”Ÿå‘½é€±æœŸ
>
>* constructorï¼šåœ¨ bot builder ä¸­ï¼Œç¯€é»çš„è™•å­˜æ–¹å¼æ˜¯ä»¥ json å­—ä¸²çš„æ–¹å¼å­˜æ”¾æ–¼è³‡æ–™åº«ä¸­ï¼Œåœ¨ç³»çµ±åŸ·è¡Œæ™‚ï¼Œæœƒå°‡é€™äº›ç¯€é»ç”¨ json parser å‡ºä¾†è®Šæˆ  json ç‰©ä»¶ï¼Œä¸¦é€é `Node Convertor` å°‡ json ç‰©ä»¶è½‰æ›æˆè…³æœ¬ï¼Œåœ¨è½‰æ›æˆæµç¨‹ï¼Œæœ€æ›è½‰æ›æˆç¯€é»åˆ°ä¸åŒç¯€é»çš„ constructor ä¸­ï¼Œå°‡é€™å€‹ç¯€é» new å‡ºä¾†ï¼Œé€™äº› json ç‰©ä»¶å°±æ˜¯åŒ…å«ä¸Šé¢æ‰€èªªçš„ç¯€é»å±¬æ€§ï¼Œé€éåˆ¤æ–· `type` æ±ºå®šè¦å°‡é€™åŒ… json å‚³çµ¦å“ªå€‹ç¯€é»çš„ constructor ä¾†å»ºç«‹
>
>* runï¼šæ­¤ç¯€é»åŸ·è¡Œæ™‚è¦åšä»€éº¼äº‹ï¼Œåœ¨ `run` ä¸­ï¼Œæ¯å€‹ç¯€é»æœƒå°‡è©²ç¯€é»çš„ payload ä¸­çš„è³‡æ–™å–å‡ºï¼Œä¸¦ä¸”æ ¹æ“šé€™äº›è³‡æ–™åŸ·è¡Œæ­¤ç¯€é»çš„åŠŸèƒ½ï¼Œå¦‚ webhook ç¯€é»æœƒåœ¨ run ä¸­ï¼Œå°‡ payload ä¸­çš„ route å–å‡ºï¼Œä¸¦ä¸”ç”¢ç”Ÿå‡º endpoint
>* removeï¼šæ­¤ç¯€é»å¾ `ç¯€é»æ± ` ä¸­è¢«ç§»é™¤æ™‚è¦åšä»€éº¼äº‹ï¼Œä¸€æ¨£ä»¥ webhook ç¯€é»ç‚ºä¾‹ï¼Œåœ¨ç§»é™¤æ™‚æœƒéœ€è¦å°‡è©² endpoint ç§»é™¤

## ç¯€é»æ± ï¼ˆnode poolï¼‰ï¼š

>åœ¨ `Node Convertor` å°‡ json å‚³å…¥ä¸åŒç¯€é»çš„ constructor ä¾† new å‡ºç¯€é»å¯¦é«”æ™‚ï¼Œæœƒå°‡é€™äº›å¯¦é«”å­˜æ”¾åœ¨ç¯€é»æ± ä¸­
>
>ç¯€é»æ± çš„å­˜æ”¾æ–¹å¼æ˜¯ä»¥ `key value` çš„æ–¹å¼å­˜æ”¾ï¼Œkey æœƒå­˜æ”¾ `ç¯€é» id`ï¼Œvalue æœƒå­˜æ”¾ new å‡ºä¾†çš„ `ç¯€é»å¯¦é«”`
>
>node pool ä¸­æœ‰å¹¾å€‹å±¬æ€§ï¼š
>
>* poolï¼šä»¥ `key value` çš„æ–¹å¼å­˜æ”¾ç¯€é»å¯¦é«”
>* getï¼šå‚³å…¥ç¯€é» idï¼Œæœƒå›å‚³è©²ç¯€é»å¯¦é«”
>* setï¼šå‚³å…¥ç¯€é» id èˆ‡ç¯€é»å¯¦é«”ï¼Œæœƒå°‡ id èˆ‡å¯¦é«”å­˜åœ¨ pool ä¸­ï¼Œkey ç‚º idï¼Œvalue ç‚ºå¯¦é«”
>* runï¼šå‚³å…¥ç¯€é» idï¼Œæœƒå–å‡º pool ä¸­çš„ç¯€é»å¯¦é«”ï¼Œä¸¦å‘¼å«è©²å¯¦é«”çš„ `run` æ–¹æ³•

## æµç¨‹ï¼ˆFlowï¼‰ï¼š

>å°‡æ•¸å€‹ç¯€é»ä¸²é€£èµ·ä¾†å°±æ˜¯ä¸€å€‹æµç¨‹ï¼Œæ¯å€‹æµç¨‹æ‡‰è©²éƒ½è¦ä»¥ `event`ç¯€é»ç‚ºé–‹é ­ï¼Œ`result` ç¯€é»ç‚ºçµæŸ

## æµç¨‹å…±äº«è®Šæ•¸ï¼ˆFlow Share Varaibleï¼‰ï¼š

>åœ¨æµç¨‹ä¸­æ¯å€‹ç¯€é»å¯èƒ½éƒ½æœƒæœ‰éœ€è¦å„²å­˜è³‡æ–™ï¼Œæˆ–æ˜¯å–å¾—å…¶ä»–ç¯€é»è™•å­˜çš„è³‡æ–™ï¼Œé€™å€‹æ™‚å€™æµç¨‹å…±äº«è®Šæ•¸å°±æ´¾ä¸Šç”¨å ´ï¼Œ
>
>æµç¨‹å…±äº«è®Šæ•¸å…§æ˜¯ä»¥ `key value` çš„æ–¹å¼ä¾†å­˜æ”¾è®Šæ•¸è³‡æ–™
>
>å±¬æ€§å¦‚ä¸‹ï¼š
>
>* storeï¼šä»¥ key value çš„æ–¹å¼å­˜æ”¾è³‡æ–™
>* getï¼šå‚³å…¥ key ä¾†å–å¾— value
>* setï¼šå‚³å…¥ key å’Œ value ä¾†å°‡é€™çµ„ key value pair å­˜åˆ° store ä¸­
>
>åœ¨åŸ·è¡Œä¸€å€‹æµç¨‹ä¹‹å‰ï¼Œæœƒå…ˆå»ºç«‹ä¸€å€‹æµç¨‹å…±äº«è®Šæ•¸
>
>ä¸¦å°‡é€™å€‹æµç¨‹å…±äº«è®Šæ•¸å‚³åˆ°åˆå§‹ç¯€é»çš„ `run` æ–¹æ³•ä¸­ï¼Œåˆå§‹ç¯€é»åœ¨ `run` æ–¹æ³•ä¸­å¦‚æœæœ‰éœ€è¦å­˜æ”¾æˆ–è®€å–è³‡æ–™ï¼Œå¯ä»¥å‘¼å« get set æ–¹æ³•ï¼Œä¹‹å¾Œç­‰åˆ°åˆå§‹ç¯€é»åŸ·è¡Œå®Œç•¢ï¼Œè¦å‘¼å«ä¸‹ä¸€å€‹ç¯€é»çš„ run æ–¹æ³•æ™‚ï¼Œå†æŠŠé€™å€‹æµç¨‹å…±äº«è®Šæ•¸å‚³ä¸‹å»ï¼Œé€™æ¨£æ•´å€‹æµç¨‹ä¸­çš„ç¯€é»å°±éƒ½å¯ä»¥å–å¾—ä¹‹å‰è¦‹é»æ‰€å­˜æ”¾çš„è®Šæ•¸è³‡æ–™äº†
>
>![æˆªåœ– 2021-05-02 ä¸Šåˆ12.29.42](https://tva1.sinaimg.cn/large/008i3skNgy1gq3e7rxitsj31780c6ac0.jpg)

## Script Parserï¼š

>ä¸Šé¢æœ‰æåˆ°åœ¨ä¸€å€‹æµç¨‹ä¸­æœƒæœ‰æµç¨‹å…±äº«è®Šæ•¸ï¼Œé‚£æˆ‘å€‘å–å¾—æˆ–è¨­å®šæµç¨‹å…±äº«è®Šæ•¸å…§çš„å€¼çš„æ–¹æ³•å°±æ˜¯é€éåœ¨ payload ä¸­åŠ å…¥
>
>`#FLOW_SHARE_VARIABLE.ä»€éº¼æ±è¥¿`ï¼Œåœ¨æ¯å€‹ç¯€é» run ä¹‹å‰ï¼Œéƒ½è¦é€é script parser ä¾†æª¢æŸ¥ payload å…§æ¬„ä½çš„å€¼æ˜¯å¦æœ‰åŒ…å« 
>
>`#FLOW_SHARE_VARIABLE`ï¼Œå¦‚æœæœ‰ï¼Œå‡è¨­æ˜¯`#FLOW_SHARE_VARIABLE.DATA.id`ï¼Œé‚£ script parser å°±æœƒå» flow share variable ä¸­ get `DATA` é€™å€‹å€¼ï¼Œä¸¦å°‡ `DATA`.`id` æ›¿æ›æ‰åŸæœ¬é€™å€‹æ¬„ä½å¾—å€¼ï¼Œå¤§è‡´å‘ä¸‹æ–¹çš„åœ–ï¼ˆæŠ±æ­‰æˆ‘çœŸçš„å¾ˆä¸æœƒè§£é‡‹ğŸ¥²
>
>![æˆªåœ– 2021-05-02 ä¸Šåˆ1.08.35](https://tva1.sinaimg.cn/large/008i3skNgy1gq3fc7ybilj315u0b275r.jpg)

## Bot è…³æœ¬ï¼ˆScriptï¼‰ï¼š

>ä¸€å€‹ script åŒ…å«å¤šå€‹ flow

## Node Convertorï¼š

>Node Convertor æ˜¯æ•´å€‹ç³»çµ±çš„æ ¸å¿ƒï¼Œç”±æ–¼ db ä¸­å­˜æ”¾çš„æµç¨‹è³‡æ–™ç‚º [react flow](https://reactflow.dev/) çš„åŸå§‹è³‡æ–™ï¼ˆæ–¹ä¾¿å‰ç«¯é¡¯ç¤ºï¼‰ï¼Œæ‰€ä»¥åœ¨ç³»çµ±å•Ÿå‹•æ™‚ï¼Œéœ€è¦å°‡åŸå§‹è³‡æ–™è½‰æ›ç‚ºä¸Šé¢çš„é‚£äº›`ç¯€é»`ã€`æµç¨‹ `ã€`è…³æœ¬` ç­‰
>
>æ•´å€‹æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼ŒåŸå§‹è³‡è¨Šä¸­å­˜æ”¾çš„å…§å®¹æœƒåƒåœ–ä¸­é¡¯ç¤ºçš„é‚£æ¨£ï¼Œé¡¯ç¤ºæœ‰å¹¾å€‹ `ç¯€é»(node)`ï¼Œç¯€é»å…§æœ‰ä»€éº¼è³‡æ–™ï¼Œç„¶å¾Œæœƒæœ‰ä¸åŒ `é‚Š(edge)` ï¼Œé€™é‚Šçš„ç¯€é»è·Ÿé‚Šéƒ½æ˜¯ react flow ä¸­æ‰€å®šç¾©çš„ï¼Œè·Ÿä¸Šé¢çš„é‚£äº›ä¸è¦æ··å†ä¸€èµ·
>
>ç¸½ä¹‹å°±æ˜¯éœ€è¦å°‡ react flow çš„åŸå§‹è³‡æ–™è½‰æ›æˆæˆ‘å€‘é€™å€‹ç³»çµ±çœ‹çš„æ‡‚çš„è³‡æ–™æ ¼å¼ï¼Œä¸¦å°‡ç¯€é» new å‡ºä¾†å¡åˆ° node pool ä¸­
>
>![æˆªåœ– 2021-05-02 ä¸Šåˆ12.52.42](https://tva1.sinaimg.cn/large/008i3skNgy1gq3evp4idbj313i0eiaci.jpg)





